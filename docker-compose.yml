services:
  noknok:
    build: .
    image: primal-noknok
    container_name: primal-noknok
    restart: unless-stopped
    env_file: .env
    secrets:
      - db_password
      - oauth_key
    networks:
      - infra
    labels:
      - "traefik.enable=true"
      # Production (HTTPS)
      - "traefik.http.routers.noknok.rule=Host(`primal.host`)"
      - "traefik.http.routers.noknok.entrypoints=https"
      - "traefik.http.routers.noknok.tls.certresolver=letsencrypt"
      # Production HTTP->HTTPS redirect
      - "traefik.http.routers.noknok-redirect.rule=Host(`primal.host`)"
      - "traefik.http.routers.noknok-redirect.entrypoints=http"
      - "traefik.http.routers.noknok-redirect.middlewares=https-redirect"
      # Redirect noknok.primal.host â†’ primal.host
      - "traefik.http.routers.noknok-old.rule=Host(`noknok.primal.host`)"
      - "traefik.http.routers.noknok-old.entrypoints=https"
      - "traefik.http.routers.noknok-old.tls.certresolver=letsencrypt"
      - "traefik.http.routers.noknok-old.middlewares=noknok-to-root"
      - "traefik.http.routers.noknok-old-http.rule=Host(`noknok.primal.host`)"
      - "traefik.http.routers.noknok-old-http.entrypoints=http"
      - "traefik.http.routers.noknok-old-http.middlewares=noknok-to-root"
      - "traefik.http.middlewares.noknok-to-root.redirectregex.regex=^https?://noknok\\.primal\\.host(.*)"
      - "traefik.http.middlewares.noknok-to-root.redirectregex.replacement=https://primal.host$${1}"
      - "traefik.http.middlewares.noknok-to-root.redirectregex.permanent=true"
      # Local (HTTP)
      - "traefik.http.routers.noknok-local.rule=Host(`noknok.localhost`)"
      - "traefik.http.routers.noknok-local.entrypoints=http"
      # Catch-all: redirect unknown domains to nokNok login
      - "traefik.http.routers.noknok-catchall.rule=HostRegexp(`.+`)"
      - "traefik.http.routers.noknok-catchall.entrypoints=http"
      - "traefik.http.routers.noknok-catchall.priority=1"
      - "traefik.http.routers.noknok-catchall.middlewares=redirect-to-primal"
      - "traefik.http.routers.noknok-catchall-https.rule=HostRegexp(`.+`)"
      - "traefik.http.routers.noknok-catchall-https.entrypoints=https"
      - "traefik.http.routers.noknok-catchall-https.priority=1"
      - "traefik.http.routers.noknok-catchall-https.tls=true"
      - "traefik.http.routers.noknok-catchall-https.middlewares=redirect-to-primal"
      - "traefik.http.middlewares.redirect-to-primal.redirectregex.regex=.*"
      - "traefik.http.middlewares.redirect-to-primal.redirectregex.replacement=https://primal.host/"
      - "traefik.http.middlewares.redirect-to-primal.redirectregex.permanent=false"
      # Service
      - "traefik.http.services.noknok.loadbalancer.server.port=4321"
      # ForwardAuth middleware (referenced by other services as "noknok-auth")
      - "traefik.http.middlewares.noknok-auth.forwardauth.address=http://primal-noknok:4321/auth"
      - "traefik.http.middlewares.noknok-auth.forwardauth.trustForwardHeader=true"
      - "traefik.http.middlewares.noknok-auth.forwardauth.authResponseHeaders=X-User-DID,X-User-Handle,X-User-Role,X-WEBAUTH-USER"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    dns:
      - 192.168.147.53

secrets:
  db_password:
    file: ${HOME}/apps/primal-host/infra/postgres/secrets/dba_noknok_password.txt
  oauth_key:
    file: ./secrets/oauth_key.txt

networks:
  infra:
    external: true
